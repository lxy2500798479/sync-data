# ğŸ›¡ï¸ æ•°æ®å®‰å…¨æŒ‡å—

## é‡è¦å£°æ˜

æœ¬è¿ç§»å·¥å…·çš„æ•°æ®å®‰å…¨ä¿è¯ï¼š

### âœ… PostgreSQL - 100% å®‰å…¨
- **åªè¿›è¡Œè¯»å–æ“ä½œ**
- ä½¿ç”¨ `SELECT` æŸ¥è¯¢è·å–æ•°æ®
- **ç»å¯¹ä¸ä¼šä¿®æ”¹ã€åˆ é™¤ä»»ä½•PostgreSQLæ•°æ®**
- å³ä½¿ç¨‹åºå‡ºé”™ä¹Ÿä¸ä¼šå½±å“æºæ•°æ®

### âš ï¸ Qdrant - ä¼šå†™å…¥æ•°æ®ï¼Œä½†æ™ºèƒ½å¤„ç†

#### é›†åˆåˆ›å»ºç­–ç•¥
```python
# å¦‚æœé›†åˆå·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º
if collection_name in existing_names:
    print(f"ğŸ“‹ é›†åˆ {collection_name} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º")
    return True
```

#### æ•°æ®æ’å…¥ç­–ç•¥ - ä½¿ç”¨ UPSERT
```python
# ä½¿ç”¨upsertæ“ä½œï¼Œä¸ä¼šä¸¢å¤±ç°æœ‰æ•°æ®
self.client.upsert(
    collection_name=collection_name,
    points=batch,
    wait=True
)
```

**UPSERT æ“ä½œè¯´æ˜ï¼š**
- å¦‚æœå‘é‡ç‚¹IDä¸å­˜åœ¨ â†’ æ’å…¥æ–°æ•°æ®
- å¦‚æœå‘é‡ç‚¹IDå·²å­˜åœ¨ â†’ æ›´æ–°ç°æœ‰æ•°æ®
- **ä¸ä¼šåˆ é™¤å…¶ä»–ç°æœ‰æ•°æ®**

#### å‘é‡ç‚¹IDæ ¼å¼
```python
# IDæ ¼å¼ï¼šå…¬å¸ID_æ„å›¾ID_é—®é¢˜ç´¢å¼•
point_id = f"{company_id}_{intent_id}_{question_index}"
# ä¾‹å¦‚ï¼šcompany_123_intent_456_0
```

## ğŸ” å…·ä½“ä¼šå‘ç”Ÿä»€ä¹ˆ

### ç¬¬ä¸€æ¬¡è¿è¡Œ
```
Qdrantä¸­ï¼š
é›†åˆ kb_company_123: ç©º
           â†“ è¿è¡Œè¿ç§»
é›†åˆ kb_company_123: [æ–°å¢100ä¸ªå‘é‡ç‚¹]
```

### ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆæ•°æ®æœ‰æ›´æ–°ï¼‰
```
Qdrantä¸­ï¼š
é›†åˆ kb_company_123: [ç°æœ‰100ä¸ªå‘é‡ç‚¹]
           â†“ è¿è¡Œè¿ç§»
é›†åˆ kb_company_123: [æ›´æ–°çš„100ä¸ªå‘é‡ç‚¹] ï¼ˆç›¸åŒIDä¼šæ›´æ–°ï¼Œä¸åŒIDä¼šä¿ç•™ï¼‰
```

### å¤šå…¬å¸åœºæ™¯
```
Qdrantä¸­ï¼š
é›†åˆ kb_company_123: [å…¬å¸123çš„æ•°æ®] â† ä¸å—å½±å“
é›†åˆ kb_company_456: [å…¬å¸456çš„æ•°æ®] â† ä¸å—å½±å“
           â†“ åªè¿ç§»å…¬å¸789
é›†åˆ kb_company_789: [æ–°å¢å…¬å¸789çš„æ•°æ®] â† æ–°åˆ›å»º
```

## ğŸš¨ æ½œåœ¨é£é™©å’Œé¢„é˜²

### é£é™©1ï¼šè¦†ç›–ç°æœ‰å‘é‡
**åœºæ™¯ï¼š** å¦‚æœåŒä¸€å…¬å¸çš„æ•°æ®è¢«å¤šæ¬¡è¿ç§»
**ç»“æœï¼š** ç›¸åŒIDçš„å‘é‡ç‚¹ä¼šè¢«æ›´æ–°ä¸ºæœ€æ–°æ•°æ®
**é¢„é˜²ï¼š** 
- æ£€æŸ¥ `sync_version` å­—æ®µé¿å…é‡å¤è¿ç§»
- å¤‡ä»½é‡è¦çš„Qdrantæ•°æ®

### é£é™©2ï¼šç£ç›˜ç©ºé—´
**åœºæ™¯ï¼š** å¤§é‡æ•°æ®è¿ç§»å¯èƒ½å ç”¨è¾ƒå¤šç£ç›˜ç©ºé—´
**é¢„é˜²ï¼š** 
- è¿è¡Œå‰æ£€æŸ¥ç£ç›˜ç©ºé—´
- ä½¿ç”¨ `--stats` é¢„ä¼°æ•°æ®é‡

### é£é™©3ï¼šç½‘ç»œä¸­æ–­
**åœºæ™¯ï¼š** é•¿æ—¶é—´è¿ç§»è¿‡ç¨‹ä¸­ç½‘ç»œä¸­æ–­
**ç»“æœï¼š** éƒ¨åˆ†æ•°æ®å·²è¿ç§»ï¼Œéƒ¨åˆ†æœªå®Œæˆ
**é¢„é˜²ï¼š** 
- æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ˆåŸºäºå‘é‡ç‚¹IDæ£€æŸ¥ï¼‰
- åˆ†æ‰¹å¤„ç†ï¼Œå‡å°‘å•æ¬¡å¤±è´¥å½±å“

## ğŸ› ï¸ å®‰å…¨ä½¿ç”¨å»ºè®®

### 1. é¦–æ¬¡ä½¿ç”¨ - æµ‹è¯•æ¨¡å¼
```bash
# å…ˆæµ‹è¯•è¿æ¥
python main.py --check

# æŸ¥çœ‹æ•°æ®ç»Ÿè®¡
python main.py --stats

# è¿ç§»å•ä¸ªå°å…¬å¸æµ‹è¯•
python main.py --company test_company_id
```

### 2. å¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆå¦‚æœé‡è¦ï¼‰
```bash
# å¯¼å‡ºç°æœ‰Qdranté›†åˆï¼ˆå¯é€‰ï¼‰
curl -X GET "http://localhost:6333/collections" > qdrant_backup.json
```

### 3. ç›‘æ§è¿ç§»è¿‡ç¨‹
```bash
# ä½¿ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼
python main.py --all --model shibing624/text2vec-base-chinese 2>&1 | tee migration.log
```

### 4. éªŒè¯è¿ç§»ç»“æœ
```bash
# è¿ç§»å®Œæˆåå†æ¬¡æ£€æŸ¥ç»Ÿè®¡
python main.py --stats
```

## ğŸ“ ç´§æ€¥æƒ…å†µå¤„ç†

### å¦‚æœéœ€è¦å®Œå…¨é‡ç½®æŸä¸ªé›†åˆ
```python
from sync_data.qdrant_manager import QdrantManager

qdrant = QdrantManager()
# åˆ é™¤é›†åˆï¼ˆè°¨æ…æ“ä½œï¼ï¼‰
qdrant.delete_collection("kb_company_123")
```

### å¦‚æœéœ€è¦æ¸…ç†ç©ºé›†åˆ
```python
# è‡ªåŠ¨æ¸…ç†ç©ºé›†åˆ
qdrant.cleanup_empty_collections()
```

## âœ… æ€»ç»“

- **PostgreSQL**: 100% å®‰å…¨ï¼Œåªè¯»æ“ä½œ
- **Qdrant**: æ™ºèƒ½å†™å…¥ï¼Œä¸ä¼šä¸¢å¤±ç°æœ‰æ•°æ®
- **å»ºè®®**: é¦–æ¬¡ä½¿ç”¨å…ˆæµ‹è¯•å°æ•°æ®é›†
- **é£é™©**: æä½ï¼Œä¸»è¦æ˜¯ç£ç›˜ç©ºé—´å’Œç½‘ç»œç¨³å®šæ€§

**ç»“è®ºï¼šè¿™ä¸ªæ“ä½œæ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šç ´åä»»ä½•ç°æœ‰æ•°æ®ï¼**
